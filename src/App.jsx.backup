import React, { useState, useEffect } from 'react';
import { Play, Pause, RotateCcw, Info } from 'lucide-react';

const KidneyFiltrationDemo = () => {
  const [isPlaying, setIsPlaying] = useState(false);
  const [time, setTime] = useState(0);
  const [selectedView, setSelectedView] = useState('both');
  const [showInfo, setShowInfo] = useState(true);

  useEffect(() => {
    let interval;
    if (isPlaying) {
      interval = setInterval(() => {
        setTime(t => (t + 0.015) % 1);
      }, 40);
    }
    return () => clearInterval(interval);
  }, [isPlaying]);

  const reset = () => {
    setTime(0);
    setIsPlaying(false);
  };

  const getBloodParticles = (type, count = 15) => {
    const particles = [];
    for (let i = 0; i < count; i++) {
      const particleTime = (time + i / count) % 1;
      let x, y, opacity;
      
      if (type === 'healthy') {
        if (particleTime < 0.3) {
          const t = particleTime / 0.3;
          x = 50 + t * 120;
          y = 200 + Math.sin(t * Math.PI) * 10;
          opacity = 0.8;
        } else if (particleTime < 0.6) {
          const t = (particleTime - 0.3) / 0.3;
          const angle = t * Math.PI * 4;
          x = 175 + Math.cos(angle) * 30;
          y = 200 + Math.sin(angle) * 30;
          opacity = 0.9;
        } else if (particleTime < 0.85) {
          const t = (particleTime - 0.6) / 0.25;
          x = 175 - t * 120;
          y = 220 + Math.sin(t * Math.PI) * 10;
          opacity = 0.8 - t * 0.5;
        } else {
          opacity = 0;
        }
      } else {
        if (particleTime < 0.35) {
          const t = particleTime / 0.35;
          x = 50 + t * 115;
          y = 200 + Math.sin(t * Math.PI * 0.8) * 12;
          opacity = 0.6;
        } else if (particleTime < 0.7) {
          const t = (particleTime - 0.35) / 0.35;
          const angle = t * Math.PI * 3;
          x = 175 + Math.cos(angle) * 25;
          y = 200 + Math.sin(angle) * 25;
          opacity = 0.65;
        } else if (particleTime < 0.95) {
          const t = (particleTime - 0.7) / 0.25;
          x = 175 - t * 115;
          y = 220 + Math.sin(t * Math.PI * 0.8) * 12;
          opacity = 0.6 - t * 0.5;
        } else {
          opacity = 0;
        }
      }
      
      if (opacity > 0) {
        particles.push({ x, y, opacity, id: i });
      }
    }
    return particles;
  };

  const getFiltrateParticles = (type, count = 10) => {
    const particles = [];
    for (let i = 0; i < count; i++) {
      const particleTime = (time + i / count + 0.35) % 1;
      let x, y, opacity;
      
      if (particleTime > 0.4 && particleTime < 0.9) {
        const t = (particleTime - 0.4) / 0.5;
        x = 175 + t * (-10);  // Move slightly left as it goes down
        y = 230 + t * 190;  // Flow all the way to y=420 (ureter exit)
        opacity = type === 'healthy' ? 0.7 - t * 0.4 : 0.5 - t * 0.3;
        particles.push({ x, y, opacity, id: i });
      }
    }
    return particles;
  };

  const HealthyKidney = () => {
    const bloodParticles = getBloodParticles('healthy');
    const filtrateParticles = getFiltrateParticles('healthy');
    
    return (
      <g>
        <image
          href="/kidney-cross-section.png"
          x="25"
          y="10"
          width="300"
          height="430"
          preserveAspectRatio="xMidYMid meet"
        />
        
        {bloodParticles.map(p => (
          <circle
            key={`blood-${p.id}`}
            cx={p.x}
            cy={p.y}
            r="3.5"
            fill="#DC143C"
            opacity={p.opacity}
          />
        ))}
        
        {filtrateParticles.map(p => (
          <circle
            key={`filtrate-${p.id}`}
            cx={p.x}
            cy={p.y}
            r="2"
            fill="#4169E1"
            opacity={p.opacity}
          />
        ))}
        
        <g fontFamily="Arial, sans-serif" fontSize="11" fill="#1a5c1a" fontWeight="600">
          {/* LEFT SIDE - Vessels */}
          <text x="-10" y="207">Renal Artery</text>
          <line x1="75" y1="204" x2="115" y2="215" stroke="#1a5c1a" strokeWidth="1.5" />
          
          <text x="-10" y="242">Renal Vein</text>
          <line x1="65" y1="239" x2="115" y2="230" stroke="#1a5c1a" strokeWidth="1.5" />
          
          {/* RIGHT SIDE - Structures (top to bottom) */}
          <text x="325" y="120">Capsule</text>
          <line x1="325" y1="123" x2="245" y2="130" stroke="#1a5c1a" strokeWidth="1.5" />
          
          <text x="325" y="175">Cortex</text>
          <line x1="325" y1="178" x2="240" y2="185" stroke="#1a5c1a" strokeWidth="1.5" />
          
          <text x="325" y="240">Medulla</text>
          <line x1="325" y1="243" x2="230" y2="250" stroke="#1a5c1a" strokeWidth="1.5" />
          
          <text x="325" y="295">Calyx</text>
          <line x1="325" y1="298" x2="210" y2="280" stroke="#1a5c1a" strokeWidth="1.5" />
          
          {/* BOTTOM - Collection System */}
          <text x="250" y="360">Pelvis</text>
          <line x1="250" y1="357" x2="185" y2="310" stroke="#1a5c1a" strokeWidth="1.5" />
          
          <text x="75" y="415">Ureter</text>
          <line x1="110" y1="412" x2="155" y2="410" stroke="#1a5c1a" strokeWidth="1.5" />
        </g>
      </g>
    );
  };

  const CKDKidney = () => {
    const bloodParticles = getBloodParticles('ckd');
    const filtrateParticles = getFiltrateParticles('ckd');
    
    const proteinParticles = [];
    for (let i = 0; i < 5; i++) {
      const particleTime = (time + i * 0.2 + 0.45) % 1;
      if (particleTime > 0.4 && particleTime < 0.9) {
        const t = (particleTime - 0.4) / 0.5;
        proteinParticles.push({
          x: 175 + t * (-8),
          y: 230 + t * 190,  // Flow all the way down to ureter exit
          opacity: 0.7 - t * 0.4,
          id: i
        });
      }
    }
    
    return (
      <g>
        <defs>
          <filter id="ckd-filter">
            <feColorMatrix type="saturate" values="0.25"/>
            <feComponentTransfer>
              <feFuncR type="linear" slope="0.65"/>
              <feFuncG type="linear" slope="0.65"/>
              <feFuncB type="linear" slope="0.65"/>
            </feComponentTransfer>
          </filter>
        </defs>
        
        <image
          href="/kidney-cross-section.png"
          x="25"
          y="10"
          width="300"
          height="430"
          preserveAspectRatio="xMidYMid meet"
          filter="url(#ckd-filter)"
        />
        
        {bloodParticles.map(p => (
          <circle
            key={`blood-ckd-${p.id}`}
            cx={p.x}
            cy={p.y}
            r="4"
            fill="#8B0000"
            opacity={p.opacity}
          />
        ))}
        
        {filtrateParticles.map(p => (
          <circle
            key={`filtrate-ckd-${p.id}`}
            cx={p.x}
            cy={p.y}
            r="2"
            fill="#4169E1"
            opacity={p.opacity * 0.6}
          />
        ))}
        
        {proteinParticles.map(p => (
          <circle
            key={`protein-${p.id}`}
            cx={p.x}
            cy={p.y}
            r="3"
            fill="#FFD700"
            opacity={p.opacity}
          />
        ))}
        
        <g fontFamily="Arial, sans-serif" fontSize="11" fill="#7a0000" fontWeight="600">
          {/* LEFT SIDE - Vessels with pathology */}
          <text x="-30" y="197">Narrowed</text>
          <text x="-30" y="209">Artery</text>
          <line x1="35" y1="203" x2="115" y2="215" stroke="#7a0000" strokeWidth="1.5" />
          
          <text x="-35" y="237">Congested</text>
          <text x="-35" y="249">Vein</text>
          <line x1="40" y1="243" x2="115" y2="230" stroke="#7a0000" strokeWidth="1.5" />
          
          {/* RIGHT SIDE - Structures with pathology (top to bottom) */}
          <text x="325" y="110">Thinned</text>
          <text x="325" y="122">Capsule</text>
          <line x1="325" y1="116" x2="245" y2="130" stroke="#7a0000" strokeWidth="1.5" />
          
          <text x="325" y="165">Atrophied</text>
          <text x="325" y="177">Cortex</text>
          <line x1="325" y1="171" x2="240" y2="185" stroke="#7a0000" strokeWidth="1.5" />
          
          <text x="325" y="230">Fibrotic</text>
          <text x="325" y="242">Medulla</text>
          <line x1="325" y1="236" x2="230" y2="250" stroke="#7a0000" strokeWidth="1.5" />
          
          <text x="325" y="285">Blunted</text>
          <text x="325" y="297">Calyx</text>
          <line x1="325" y1="291" x2="210" y2="280" stroke="#7a0000" strokeWidth="1.5" />
          
          <text x="325" y="335" fill="#B8860B">Proteinuria</text>
          <line x1="325" y1="332" x2="210" y2="270" stroke="#B8860B" strokeWidth="1.5" strokeDasharray="3,2" />
          
          {/* BOTTOM - Collection System with pathology */}
          <text x="235" y="350">Dilated</text>
          <text x="240" y="362">Pelvis</text>
          <line x1="235" y1="356" x2="185" y2="310" stroke="#7a0000" strokeWidth="1.5" />
          
          <text x="75" y="415">Ureter</text>
          <line x1="110" y1="412" x2="155" y2="410" stroke="#7a0000" strokeWidth="1.5" />
        </g>
      </g>
    );
  };

  return (
    <div className="w-full min-h-screen bg-white py-8">
      <div className="max-w-7xl mx-auto px-6">
        <div className="mb-8">
          <h1 className="text-4xl font-bold text-gray-900 mb-3">
            Renal Filtration Dynamics: Healthy vs. Chronic Kidney Disease
          </h1>
          <p className="text-lg text-gray-600">
            Comparative demonstration of glomerular filtration and tubular function in normal and CKD-affected nephrons
          </p>
        </div>

        <div className="flex gap-3 mb-6">
          <button
            onClick={() => setSelectedView('both')}
            className={`px-6 py-3 rounded-lg font-semibold ${
              selectedView === 'both' ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 border-2 border-gray-200'
            }`}
          >
            Compare Both
          </button>
          <button
            onClick={() => setSelectedView('healthy')}
            className={`px-6 py-3 rounded-lg font-semibold ${
              selectedView === 'healthy' ? 'bg-green-600 text-white' : 'bg-white text-gray-700 border-2 border-gray-200'
            }`}
          >
            Healthy Kidney
          </button>
          <button
            onClick={() => setSelectedView('ckd')}
            className={`px-6 py-3 rounded-lg font-semibold ${
              selectedView === 'ckd' ? 'bg-red-600 text-white' : 'bg-white text-gray-700 border-2 border-gray-200'
            }`}
          >
            CKD Kidney
          </button>
        </div>

        {selectedView === 'both' ? (
          <div className="grid md:grid-cols-2 gap-6 mb-8">
            <div className="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 shadow-lg border-2 border-green-300">
              <h3 className="text-xl font-bold text-green-900 mb-4 text-center">Healthy Kidney</h3>
              <svg width="100%" height="450" viewBox="0 0 350 450">
                <HealthyKidney />
              </svg>
            </div>
            
            <div className="bg-gradient-to-br from-red-50 to-rose-50 rounded-xl p-6 shadow-lg border-2 border-red-300">
              <h3 className="text-xl font-bold text-red-900 mb-4 text-center">Unhealthy Kidney</h3>
              <svg width="100%" height="450" viewBox="0 0 350 450">
                <CKDKidney />
              </svg>
            </div>
          </div>
        ) : (
          <div className="flex justify-center mb-8">
            <div className={`rounded-xl p-6 shadow-lg border-2 w-full max-w-md ${
              selectedView === 'healthy' 
                ? 'bg-gradient-to-br from-green-50 to-emerald-50 border-green-300' 
                : 'bg-gradient-to-br from-red-50 to-rose-50 border-red-300'
            }`}>
              <h3 className={`text-xl font-bold mb-4 text-center ${
                selectedView === 'healthy' ? 'text-green-900' : 'text-red-900'
              }`}>
                {selectedView === 'healthy' ? 'Healthy Kidney' : 'Unhealthy Kidney'}
              </h3>
              <svg width="100%" height="450" viewBox="0 0 350 450">
                {selectedView === 'healthy' ? <HealthyKidney /> : <CKDKidney />}
              </svg>
            </div>
          </div>
        )}

        <div className="flex gap-4 mb-6">
          <button
            onClick={() => setIsPlaying(!isPlaying)}
            className="flex items-center gap-2 px-8 py-4 bg-blue-600 text-white rounded-lg hover:bg-blue-700 font-semibold"
          >
            {isPlaying ? <><Pause size={22} /> Pause Animation</> : <><Play size={22} /> Play Animation</>}
          </button>
          <button
            onClick={reset}
            className="flex items-center gap-2 px-8 py-4 bg-gray-600 text-white rounded-lg hover:bg-gray-700 font-semibold"
          >
            <RotateCcw size={22} /> Reset
          </button>
          <button
            onClick={() => setShowInfo(!showInfo)}
            className="flex items-center gap-2 px-8 py-4 bg-white text-gray-700 rounded-lg border-2 border-gray-200 font-semibold"
          >
            <Info size={22} /> {showInfo ? 'Hide' : 'Show'} Details
          </button>
        </div>

        {showInfo && (
          <div className="grid md:grid-cols-2 gap-6">
            <div className="bg-gradient-to-br from-green-50 to-emerald-50 p-6 rounded-xl border-2 border-green-300">
              <h3 className="text-xl font-bold text-green-900 mb-4">Healthy Kidney Function</h3>
              <div className="space-y-2 text-sm text-gray-800">
                <div><span className="font-bold">GFR:</span> 90-120 mL/min/1.73m²</div>
                <div><span className="font-bold">Blood Flow:</span> ~1,200 mL/min</div>
                <div><span className="font-bold">Filtration:</span> Selective barrier retains albumin</div>
              </div>
            </div>

            <div className="bg-gradient-to-br from-red-50 to-rose-50 p-6 rounded-xl border-2 border-red-300">
              <h3 className="text-xl font-bold text-red-900 mb-4">CKD Pathophysiology</h3>
              <div className="space-y-2 text-sm text-gray-800">
                <div><span className="font-bold">Reduced GFR:</span> &lt;60 mL/min/1.73m²</div>
                <div><span className="font-bold">Blood Flow:</span> Reduced perfusion</div>
                <div><span className="font-bold">Proteinuria:</span> Albumin leakage (gold particles)</div>
              </div>
            </div>
          </div>
        )}
      </div>
    </div>
  );
};

export default KidneyFiltrationDemo;
